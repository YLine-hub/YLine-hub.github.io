<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="SQL优化 插入数据 insert优化 批量插入 1 insert into tb_test values(1,&#39;Tom&#39;),(2,&#39;Cat&#39;),(3,&#39;jerry&#39;); 不建议一条一条数据插入\n手动提交事务 1 2 3 4 5 start transation; insert into tb_test values(1,&#39;Tom&#39;),(2,&#39;Cat&#39;),(3,&#39;jerry&#39;); insert into tb_test values(4,&#39;Tom&#39;),(5,&#39;Cat&#39;),(6,&#39;jerry&#39;); insert into tb_test values(7,&#39;Tom&#39;),(8,&#39;Cat&#39;),(9,&#39;jerry&#39;); commit; MySQL默认自动提交事务，当插入一条语句之前，他会开启事务，插入语句之后，会提交事务。所以当插入多条语句时，会频繁提交事务。所以建议手动提交事务。\n">
<title>[MySQL]MySQL进阶-SQL优化</title>

<link rel='canonical' href='https://YLine-hub.github.io/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/'>

<link rel="stylesheet" href="/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css"><meta property='og:title' content="[MySQL]MySQL进阶-SQL优化">
<meta property='og:description' content="SQL优化 插入数据 insert优化 批量插入 1 insert into tb_test values(1,&#39;Tom&#39;),(2,&#39;Cat&#39;),(3,&#39;jerry&#39;); 不建议一条一条数据插入\n手动提交事务 1 2 3 4 5 start transation; insert into tb_test values(1,&#39;Tom&#39;),(2,&#39;Cat&#39;),(3,&#39;jerry&#39;); insert into tb_test values(4,&#39;Tom&#39;),(5,&#39;Cat&#39;),(6,&#39;jerry&#39;); insert into tb_test values(7,&#39;Tom&#39;),(8,&#39;Cat&#39;),(9,&#39;jerry&#39;); commit; MySQL默认自动提交事务，当插入一条语句之前，他会开启事务，插入语句之后，会提交事务。所以当插入多条语句时，会频繁提交事务。所以建议手动提交事务。\n">
<meta property='og:url' content='https://YLine-hub.github.io/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/'>
<meta property='og:site_name' content='リンボの個人ブログ'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-11-17T17:05:01&#43;08:00'/><meta property='article:modified_time' content='2025-11-17T17:05:01&#43;08:00'/>
<meta name="twitter:title" content="[MySQL]MySQL进阶-SQL优化">
<meta name="twitter:description" content="SQL优化 插入数据 insert优化 批量插入 1 insert into tb_test values(1,&#39;Tom&#39;),(2,&#39;Cat&#39;),(3,&#39;jerry&#39;); 不建议一条一条数据插入\n手动提交事务 1 2 3 4 5 start transation; insert into tb_test values(1,&#39;Tom&#39;),(2,&#39;Cat&#39;),(3,&#39;jerry&#39;); insert into tb_test values(4,&#39;Tom&#39;),(5,&#39;Cat&#39;),(6,&#39;jerry&#39;); insert into tb_test values(7,&#39;Tom&#39;),(8,&#39;Cat&#39;),(9,&#39;jerry&#39;); commit; MySQL默认自动提交事务，当插入一条语句之前，他会开启事务，插入语句之后，会提交事务。所以当插入多条语句时，会频繁提交事务。所以建议手动提交事务。\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_7f398a7818085507.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🏖️</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">リンボの個人ブログ</a></h1>
            <h2 class="site-description">努力不一定能获得回报，但不努力一定不会有回报。</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#插入数据">插入数据</a>
      <ol>
        <li><a href="#insert优化">insert优化</a>
          <ol>
            <li><a href="#批量插入">批量插入</a></li>
            <li><a href="#手动提交事务">手动提交事务</a></li>
            <li><a href="#主键顺序插入">主键顺序插入</a></li>
            <li><a href="#大批量插入数据">大批量插入数据</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#主键优化">主键优化</a>
      <ol>
        <li><a href="#数据组织方式">数据组织方式</a></li>
        <li><a href="#页分裂">页分裂</a></li>
        <li><a href="#页合并">页合并</a></li>
        <li><a href="#主键设计原则">主键设计原则</a></li>
      </ol>
    </li>
    <li><a href="#order-by优化">order by优化</a></li>
    <li><a href="#group-by优化">group by优化</a></li>
    <li><a href="#limit优化">limit优化</a></li>
    <li><a href="#count优化">count优化</a>
      <ol>
        <li><a href="#概述">概述</a></li>
        <li><a href="#count用法">count用法</a></li>
        <li><a href="#演示-1">演示</a></li>
      </ol>
    </li>
    <li><a href="#update优化">update优化</a>
      <ol>
        <li><a href="#演示-2">演示</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/mysql/" >
                MySQL
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/">[MySQL]MySQL进阶-SQL优化</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-11-17</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="sql优化">SQL优化
</h1><h2 id="插入数据">插入数据
</h2><h3 id="insert优化">insert优化
</h3><h4 id="批量插入">批量插入
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">tb_test</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;Tom&#39;</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;Cat&#39;</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;jerry&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>不建议一条一条数据插入</p>
<h4 id="手动提交事务">手动提交事务
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">start</span><span class="w"> </span><span class="n">transation</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">tb_test</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;Tom&#39;</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;Cat&#39;</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;jerry&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">tb_test</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;Tom&#39;</span><span class="p">),(</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;Cat&#39;</span><span class="p">),(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;jerry&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">tb_test</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;Tom&#39;</span><span class="p">),(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;Cat&#39;</span><span class="p">),(</span><span class="mi">9</span><span class="p">,</span><span class="s1">&#39;jerry&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">commit</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>MySQL默认自动提交事务，当插入一条语句之前，他会开启事务，插入语句之后，会提交事务。所以当插入多条语句时，会频繁提交事务。所以建议手动提交事务。</p>
<h4 id="主键顺序插入">主键顺序插入
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">主键乱序插入：8 1 9 21 88 2 4 15 89 5 7 3
</span></span><span class="line"><span class="cl">主键顺序插入：1 2 3 4 5 7 8 9 15 21 88 89
</span></span></code></pre></td></tr></table>
</div>
</div><p>主键顺序插入的性能，要高于乱序插入。</p>
<h4 id="大批量插入数据">大批量插入数据
</h4><ul>
<li>如果一次性需要插入大量数据，使用insert语句插入性能较低，此时可以使用MySQL提供的load指令进行插入。操作如下：</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image.png"
	width="884"
	height="200"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image_hu_59aefaf3f411fd20.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image_hu_66c3c8c8aee47b6e.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="442"
		data-flex-basis="1060px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="c1"># 客户端连接服务器时，加上参数 --local-infile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">mysql</span><span class="w"> </span><span class="o">--</span><span class="n">local</span><span class="o">-</span><span class="k">infile</span><span class="w"> </span><span class="o">-</span><span class="n">uroot</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1"># 设置全局参数local_infile为1，开启从本地加载文件导入数据的开关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">set</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">local_infile</span><span class="o">=</span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1"># 执行local指令将准备好的数据，加载到表结构中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">local</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="k">infile</span><span class="w"> </span><span class="s1">&#39;/root/sql1.log&#39;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">`</span><span class="n">tb_user</span><span class="o">`</span><span class="w"> </span><span class="n">fileds</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="k">lines</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="演示">演示
</h5><ul>
<li>数据准备</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">tb_user</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">username</span><span class="o">`</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">password</span><span class="o">`</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">birthday</span><span class="o">`</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">sex</span><span class="o">`</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">unique_user_username</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">username</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">INNODB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>客户端连接服务端时，加上参数 -–local-infile</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysql –-local-infile -uroot -p
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-42.png"
	width="1114"
	height="534"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-42_hu_286cdcb90f131e9.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-42_hu_8c721a81c24d3df5.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="208"
		data-flex-basis="500px"
	
></p>
<ul>
<li>查看系统变量local_infile</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select @@local_infile;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-43.png"
	width="426"
	height="254"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-43_hu_4cb8110816376a1.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-43_hu_9c81b61dc68ad5ef.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="167"
		data-flex-basis="402px"
	
></p>
<ul>
<li>设置全局参数local_infile为1，开启从本地加载文件导入数据的开关</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">set global local_infile = 1;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-44.png"
	width="530"
	height="352"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-44_hu_2169337b22afcbaf.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-44_hu_3fef23dc2c1f8259.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="150"
		data-flex-basis="361px"
	
></p>
<ul>
<li>查看文件行数</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="n">load_user_100w_sort</span><span class="o">.</span><span class="n">sql</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-46.png"
	width="640"
	height="68"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-46_hu_36cee2b0f387e12f.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-46_hu_4a2b1025988bd60c.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="941"
		data-flex-basis="2258px"
	
></p>
<ul>
<li>[Mac]上传sql文件到服务器/root/sql目录下</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">scp</span> <span class="n">load_user_100w_sort</span><span class="o">.</span><span class="n">sql</span> <span class="n">root</span><span class="err">@</span><span class="mf">172.16</span><span class="o">.</span><span class="mf">140.101</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">sql</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-45.png"
	width="1082"
	height="102"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-45_hu_3b2e98be0d5d62ca.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-45_hu_71e7bd62227edc4c.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="1060"
		data-flex-basis="2545px"
	
></p>
<ul>
<li>load加载数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">load</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">infile</span><span class="w"> </span><span class="s1">&#39;/root/sql/load_user_100w_sort.sql&#39;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">tb_user</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-47.png"
	width="1916"
	height="106"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-47_hu_25aa073d454c988.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-47_hu_e10ba6be4d5e7c43.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="1807"
		data-flex-basis="4338px"
	
></p>
<p>我们看到，插入100w的记录，6.75s就完成了，性能很好。</p>
<blockquote>
<p>在load时，主键顺序插入性能高于乱序插入。</p>
</blockquote>
<h2 id="主键优化">主键优化
</h2><h3 id="数据组织方式">数据组织方式
</h3><ul>
<li>在InnoDB存储引擎中，表数据都是根据主键顺序组织存放的，这种存储方式的表称为索引组织表(index organized table 简称IOT)</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-1.png"
	width="884"
	height="332"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-1_hu_4970f65233b9a2a8.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-1_hu_ed63a8bfb956bea4.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="266"
		data-flex-basis="639px"
	
></p>
<ul>
<li>行数据，都是存储在聚集索引的叶子结点上的。InnoDB的逻辑存储结构：</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-2.png"
	width="884"
	height="340"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-2_hu_fac4c6ebe43f1486.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-2_hu_92f0194fd7d14bdb.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="260"
		data-flex-basis="624px"
	
></p>
<h3 id="页分裂">页分裂
</h3><ul>
<li>页可以为空，也可以填充一半，也可以填充100%。每个页包含了2-N行数据(如果一行数据大，会行溢出)，根据主键排列。</li>
</ul>
<p>A. 主键顺序插入效果</p>
<ol>
<li>从磁盘中申请页， 主键顺序插入</li>
</ol>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-3.png"
	width="758"
	height="240"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-3_hu_70b7c5fdd460718f.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-3_hu_563f4a33deb7c448.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="315"
		data-flex-basis="758px"
	
></p>
<ol start="2">
<li>第一个页没有满，继续往第一页插入</li>
</ol>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-4.png"
	width="766"
	height="230"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-4_hu_b623d7e697f3bd09.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-4_hu_69c863fe0d758116.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="333"
		data-flex-basis="799px"
	
></p>
<ol start="3">
<li>当第一个也写满之后，再写入第二个页，页与页之间会通过指针连接</li>
</ol>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-5.png"
	width="884"
	height="134"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-5_hu_69f10f27f3be5a22.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-5_hu_a8099e7f6b2aa899.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="659"
		data-flex-basis="1583px"
	
></p>
<ol start="4">
<li>当第二页写满了，再往第三页写入</li>
</ol>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-6.png"
	width="884"
	height="94"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-6_hu_3357582341599a66.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-6_hu_4312d6cd1439a0ec.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="940"
		data-flex-basis="2257px"
	
></p>
<p>B. 主键乱序插入效果</p>
<ol>
<li>加入1#,2#页都已经写满了，存放了如图所示的数据</li>
</ol>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-7.png"
	width="884"
	height="142"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-7_hu_ba5c04bc10d6671a.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-7_hu_fdc06c8812027aef.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="622"
		data-flex-basis="1494px"
	
></p>
<ol start="2">
<li>此时再插入id为50的记录，我们来看看会发生什么现象<br> 会再次开启一个页，写入新的页中吗?</li>
</ol>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-8.png"
	width="884"
	height="226"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-8_hu_179d4fdaa768ab5.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-8_hu_e3402a61ac5c9d0f.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="391"
		data-flex-basis="938px"
	
></p>
<p>不会。因为，索引结构的叶子节点是有顺序的。按照顺序，应该存储在47之后。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-9.png"
	width="884"
	height="336"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-9_hu_d3b5189bfc235410.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-9_hu_98eef2dd2cc87468.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="263"
		data-flex-basis="631px"
	
></p>
<p>但是47所在的1#页，已经写满了，存储不了50对应的数据了。 那么此时会开辟一个新的页 3#。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-10.png"
	width="884"
	height="88"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-10_hu_3b76c5309926828b.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-10_hu_636b7ce786f5f447.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="1004"
		data-flex-basis="2410px"
	
></p>
<p>但是并不会直接将50存入3#页，而是会将1#页后一半的数据，移动到3#页，然后在3#页，插入50。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-11.png"
	width="884"
	height="86"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-11_hu_217568c267914217.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-11_hu_75ac92af12171dc.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="1027"
		data-flex-basis="2466px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-12.png"
	width="884"
	height="84"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-12_hu_81e20b897748cc7e.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-12_hu_4e0430b9817f24be.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="1052"
		data-flex-basis="2525px"
	
></p>
<p>移动数据，并插入id为50的数据之后，那么此时，这三个页之间的数据顺序是有问题的。 1#的下一个 页，应该是3#， 3#的下一个页是2#。 所以，此时，需要重新设置链表指针。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-13.png"
	width="884"
	height="106"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-13_hu_6b2cc66eeb5f2b4a.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-13_hu_2ba3c8c96a087c66.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="833"
		data-flex-basis="2001px"
	
></p>
<p>上述的这种现象，称之为 &ldquo;页分裂&rdquo;，是比较耗费性能的操作。</p>
<h3 id="页合并">页合并
</h3><p>目前表中已有数据的索引结构(叶子节点)如下:</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-14.png"
	width="884"
	height="98"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-14_hu_bd958fb2d8e4f4e5.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-14_hu_2635c4215e6f0961.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="902"
		data-flex-basis="2164px"
	
></p>
<p>当我们对已有数据进行删除时，具体的效果如下:</p>
<p>当删除一行记录时，实际上记录并没有被物理删除，只是记录被标记(flaged)为删除并且它的空间变得允许被其他记录声明使用。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-15.png"
	width="884"
	height="98"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-15_hu_ca2b259ad0ada9b3.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-15_hu_fe2e21a907b0b968.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="902"
		data-flex-basis="2164px"
	
></p>
<p>当我们继续删除2#的数据记录</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-16.png"
	width="884"
	height="142"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-16_hu_8aa5d3c61f136ac9.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-16_hu_3134dfc4f5dbf3a0.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="622"
		data-flex-basis="1494px"
	
></p>
<p>当页中删除的记录达到 MERGE_THRESHOLD(默认为页的50%)，InnoDB会开始寻找最靠近的页(前 或后)看看是否可以将两个页合并以优化空间使用。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-17.png"
	width="884"
	height="142"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-17_hu_54320ebfdd823eb2.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-17_hu_85cdcbc2f7a75887.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="622"
		data-flex-basis="1494px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-18.png"
	width="884"
	height="102"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-18_hu_bba7cc25ed54fc7.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-18_hu_bbae4f1e9711f181.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="866"
		data-flex-basis="2080px"
	
></p>
<p>删除数据，并将页合并之后，再次插入新的数据21，则直接插入3#页</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-19.png"
	width="884"
	height="100"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-19_hu_a7b07523b3577421.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-19_hu_4a52434de241a73d.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="884"
		data-flex-basis="2121px"
	
></p>
<p>这个里面所发生的合并页的这个现象，就称之为 &ldquo;页合并&rdquo;。</p>
<blockquote>
<p>知识小贴士: <br>MERGE_THRESHOLD:合并页的阈值，可以自己设置，在创建表或者创建索引时指定。</p>
</blockquote>
<h3 id="主键设计原则">主键设计原则
</h3><ul>
<li>满足业务需求的情况下，尽量降低主键的长度。</li>
<li>插入数据时，尽量选择顺序插入，选择使用AUTO_INCREMENT自增主键。</li>
<li>尽量不要使用UUID做主键或者是其他自然主键，如身份证号。</li>
<li>业务操作时，避免对主键的修改。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-20.png"
	width="884"
	height="322"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-20_hu_157049a64f2e10ee.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-20_hu_be6299abb00f3140.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="274"
		data-flex-basis="658px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-21.png"
	width="884"
	height="340"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-21_hu_a0291174816f35a7.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-21_hu_7241c757cba213cc.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="260"
		data-flex-basis="624px"
	
></p>
<h2 id="order-by优化">order by优化
</h2><p>MySQL的排序，有两种方式:</p>
<ul>
<li><code>Using filesort</code> : 通过表的索引或全表扫描，读取满足条件的数据行，然后在排序缓冲区sort buffer中完成排序操作，所有不是通过索引直接返回排序结果的排序都叫 FileSort 排序。</li>
<li><code>Using index</code> : 通过有序索引顺序扫描直接返回有序数据，这种情况即为 using index，不需要 额外排序，操作效率高。</li>
</ul>
<p>对于以上的两种排序方式，Using index的性能高，而Using filesort的性能低，我们在优化排序 操作时，尽量要优化为 Using index。</p>
<p>接下来做个测试：</p>
<ul>
<li>数据准备</li>
</ul>
<p>把之前测试时，为tb_user表所建立的部分索引直接删除掉</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">drop index idx_user_phone on tb_user;
</span></span><span class="line"><span class="cl">drop index index_user_name on tb_user;
</span></span><span class="line"><span class="cl">drop index idx_user_age on tb_user;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-22.png"
	width="2700"
	height="376"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-22_hu_31462cd0f7425e7e.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-22_hu_c45df656fe4603c9.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="718"
		data-flex-basis="1723px"
	
></p>
<ul>
<li>查询tb_user表的id，age，phone根据age升序排序(执行计划)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select id, age, phone from tb_user order by age;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-23.png"
	width="1784"
	height="258"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-23_hu_c22611a31949eda2.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-23_hu_77d9a7f3ca38c8c9.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="691"
		data-flex-basis="1659px"
	
></p>
<ul>
<li>查询tb_user表的id，age，phone根据age升序排序，若age相同则按照phone升序排序(执行计划)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select id, age, phone from tb_user order by age, phone;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-24.png"
	width="1780"
	height="250"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-24_hu_a04180f7eb2726b5.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-24_hu_612035130f103c4a.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="712"
		data-flex-basis="1708px"
	
></p>
<p>由于 age, phone 都没有索引，所以此时再排序时，出现Using filesort， 排序性能较低。</p>
<ul>
<li>创建索引</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">create index idx_user_age_phone_aa on tb_user(age, phone);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-25.png"
	width="2726"
	height="450"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-25_hu_62c724dd9def2037.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-25_hu_6a175954ce83e92f.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="605"
		data-flex-basis="1453px"
	
></p>
<ul>
<li>查询tb_user表的id，age，phone根据age升序排序(执行计划)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select id, age, phone from tb_user order by age;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-26.png"
	width="1992"
	height="252"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-26_hu_3e806664c0a1e8d0.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-26_hu_b9fa28e77c59b99c.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="790"
		data-flex-basis="1897px"
	
></p>
<ul>
<li>查询tb_user表的id，age，phone根据age升序排序，若age相同则按照phone升序排序(执行计划)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select id, age, phone from tb_user order by age, phone;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-27.png"
	width="1984"
	height="250"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-27_hu_a16ac55add27f2c4.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-27_hu_6b7e0e632731137f.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="793"
		data-flex-basis="1904px"
	
></p>
<p>建立索引之后，再次进行排序查询，就由原来的Using filesort， 变为了 Using index，性能 就是比较高的了。</p>
<ul>
<li>查询tb_user表的id，age，phone根据age，phone进行降序排序。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-28.png"
	width="2292"
	height="248"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-28_hu_ecc568be60d38c7b.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-28_hu_63b56e14c8c4d29.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="924"
		data-flex-basis="2218px"
	
></p>
<p>也出现 Using index， 但是此时Extra中出现了 Backward index scan，这个代表反向扫描索 引，因为在MySQL中我们创建的索引，默认索引的叶子节点是从小到大排序的，而此时我们查询排序 时，是从大到小，所以，在扫描时，就是反向扫描，就会出现 Backward index scan。 在 MySQL8版本中，支持降序索引，我们也可以创建降序索引。</p>
<ul>
<li>查询tb_user表的id，age，phone根据phone，age进行升序排序。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select id, age, phone from tb_user order by phone, age;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-29.png"
	width="2216"
	height="246"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-29_hu_666851dc7acf9316.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-29_hu_c3e369f394261e65.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="900"
		data-flex-basis="2161px"
	
></p>
<p>排序时,也需要满足最左前缀法则,否则也会出现 filesort。因为在创建索引的时候， age是第一个 字段，phone是第二个字段，所以排序时，也就该按照这个顺序来，否则就会出现 Using filesort。</p>
<ul>
<li>查询tb_user表的id，age，phone根据age升序，phone降序排序。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select id, age, phone from tb_user order by age asc, phone desc;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-30.png"
	width="2216"
	height="242"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-30_hu_4cdffdaeb33e8e1c.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-30_hu_c0e5ec1035b70a30.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="915"
		data-flex-basis="2197px"
	
></p>
<p>因为创建索引时，如果未指定顺序，默认都是按照升序排序的，而查询时，一个升序，一个降序，此时 就会出现Using filesort。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-31.png"
	width="2714"
	height="448"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-31_hu_11241c73b5d8bbb1.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-31_hu_1c6b0769a2a2db63.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="605"
		data-flex-basis="1453px"
	
></p>
<p>为了解决上述的问题，我们可以创建一个索引，这个联合索引中 age 升序排序，phone 倒序排序。</p>
<ul>
<li>创建联合索引(age 升序排序，phone 降序排序)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">create index idx_user_age_phone_ad on tb_user(age asc, phone desc);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-32.png"
	width="2708"
	height="516"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-32_hu_4f8ffe51daf0d533.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-32_hu_c01d584bb075cc39.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="524"
		data-flex-basis="1259px"
	
></p>
<ul>
<li>查询tb_user表的id，age，phone根据age升序，phone降序排序。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select id, age, phone from tb_user order by age asc, phone desc;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-33.png"
	width="1984"
	height="250"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-33_hu_6d5b655493142ad8.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-33_hu_3a17760018029aa4.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="793"
		data-flex-basis="1904px"
	
></p>
<p>升序/降序联合索引结构图示:</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-34.png"
	width="884"
	height="98"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-34_hu_4abfec4eb719c98b.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-34_hu_5257ad791c24771e.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="902"
		data-flex-basis="2164px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-35.png"
	width="884"
	height="68"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-35_hu_6e6443a991530fae.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-35_hu_c418069cb21945a1.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="1300"
		data-flex-basis="3120px"
	
></p>
<p>由上述的测试,我们得出order by优化原则:</p>
<ol>
<li>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则。</li>
<li>尽量使用覆盖索引。</li>
<li>多字段排序, 一个升序一个降序，此时需要注意联合索引在创建时的规则(ASC/DESC)。</li>
<li>如果不可避免的出现filesort，大数据量排序时，可以适当增大排序缓冲区大小 sort_buffer_size(默认256k)。</li>
</ol>
<h2 id="group-by优化">group by优化
</h2><ul>
<li>删除所有的索引</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">drop index idx_user_pro_age_sta on tb_user;
</span></span><span class="line"><span class="cl">drop index idx_email_5 on tb_user;
</span></span><span class="line"><span class="cl">drop index idx_user_age_phone_aa on tb_user;
</span></span><span class="line"><span class="cl">drop index idx_user_age_phone_ad on tb_user;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-36.png"
	width="2536"
	height="248"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-36_hu_611d5175a553a6d8.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-36_hu_a9458fc9cffd3276.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="1022"
		data-flex-basis="2454px"
	
></p>
<ul>
<li>查询tb_user的专业，数量，根据专业分组排序(执行计划)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select profession, count(*) from tb_user group by profession;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-37.png"
	width="1812"
	height="252"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-37_hu_6998da590feb2c36.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-37_hu_2240200502d88f97.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="719"
		data-flex-basis="1725px"
	
></p>
<p>可以看到是全表扫描，以及使用了临时表，性能较低。</p>
<ul>
<li>使用profession , age , status创建联合索引idx_user_pro_age_sta</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">create index idx_user_pro_age_sta on tb_user(profession , age, status);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-38.png"
	width="2700"
	height="340"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-38_hu_3628dbf67f31b399.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-38_hu_239b0996059a3b1b.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="794"
		data-flex-basis="1905px"
	
></p>
<ul>
<li>查询tb_user的专业，数量，根据专业分组排序(执行计划)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select profession, count(*) from tb_user group by profession;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-39.png"
	width="2084"
	height="248"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-39_hu_1c503b89d72762d.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-39_hu_57d8222b7a4b1012.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="840"
		data-flex-basis="2016px"
	
></p>
<ul>
<li>查询tb_user的专业，数量，根据专业和年龄分组排序(执行计划)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select profession, count(*) from tb_user group by profession, age;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-40.png"
	width="2078"
	height="252"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-40_hu_3dbf4464fee934ab.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-40_hu_7cd606cbdf8f015a.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="824"
		data-flex-basis="1979px"
	
></p>
<ul>
<li>查询tb_user的专业，数量，根据年龄分组排序(执行计划)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select age, count(*) from tb_user group by age;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-41.png"
	width="2320"
	height="256"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-41_hu_abb2033fcaefc859.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-41_hu_9947ea229514cb82.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="906"
		data-flex-basis="2175px"
	
></p>
<p>我们发现，如果仅仅根据age分组，就会出现 Using temporary ;而如果是 根据 profession,age两个字段同时分组，则不会出现 Using temporary。原因是因为对于分组操作， 在联合索引中，也是符合最左前缀法则的。</p>
<p>所以，在分组操作中，我们需要通过以下两点进行优化，以提升性能:</p>
<ol>
<li>在分组操作时，可以通过索引来提高效率。</li>
<li>分组操作时，索引的使用也是满足最左前缀法则的</li>
</ol>
<h2 id="limit优化">limit优化
</h2><ul>
<li>
<p>在数据量比较大时，如果进行limit分页查询，在查询时，越往后，分页查询效率越低。</p>
</li>
<li>
<p>执行limit分页查询耗时对比:</p>
</li>
<li>
<p>数据准备(tb_sku表)</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">tb_sku</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="kp">AUTO_INCREMENT</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">sn</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品条码&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;SKU名称&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">price</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;价格（分）&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">num</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;库存数量&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">alert_num</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;库存预警数量&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">image</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品图片&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">images</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品图片列表&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">weight</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;重量（克）&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">create_time</span><span class="o">`</span><span class="w"> </span><span class="kt">datetime</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;创建时间&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">update_time</span><span class="o">`</span><span class="w"> </span><span class="kt">datetime</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;更新时间&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">category_name</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;类目名称&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">brand_name</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;品牌名称&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">spec</span><span class="o">`</span><span class="w"> </span><span class="kt">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;规格&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">sale_num</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;销量&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;评论数&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">status</span><span class="o">`</span><span class="w"> </span><span class="kt">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="w"> </span><span class="n">COMMENT</span><span class="w"> </span><span class="s1">&#39;商品状态 1-正常，2-下架，3-删除&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">BTREE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="kp">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="kp">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="w"> </span><span class="n">COMMENT</span><span class="o">=</span><span class="s1">&#39;商品表&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>上传数据文件到服务器</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">scp tb_sku1.sql root@172.16.140.101:/root/sql
</span></span><span class="line"><span class="cl">scp tb_sku2.sql root@172.16.140.101:/root/sql
</span></span><span class="line"><span class="cl">scp tb_sku3.sql root@172.16.140.101:/root/sql
</span></span><span class="line"><span class="cl">scp tb_sku4.sql root@172.16.140.101:/root/sql
</span></span><span class="line"><span class="cl">scp tb_sku5.sql root@172.16.140.101:/root/sql
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>加载数据到tb_sku表中</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">load</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="k">infile</span><span class="w"> </span><span class="s1">&#39;/root/sql/tb_sku1.sql&#39;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">`</span><span class="n">tb_sku</span><span class="o">`</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="k">lines</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">load</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="k">infile</span><span class="w"> </span><span class="s1">&#39;/root/sql/tb_sku2.sql&#39;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">`</span><span class="n">tb_sku</span><span class="o">`</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="k">lines</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">load</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="k">infile</span><span class="w"> </span><span class="s1">&#39;/root/sql/tb_sku3.sql&#39;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">`</span><span class="n">tb_sku</span><span class="o">`</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="k">lines</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">load</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="k">infile</span><span class="w"> </span><span class="s1">&#39;/root/sql/tb_sku4.sql&#39;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">`</span><span class="n">tb_sku</span><span class="o">`</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="k">lines</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">load</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="k">infile</span><span class="w"> </span><span class="s1">&#39;/root/sql/tb_sku5.sql&#39;</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">`</span><span class="n">tb_sku</span><span class="o">`</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="k">lines</span><span class="w"> </span><span class="k">terminated</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>查询tb_sku表第1条开始的10条数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select * from tb_sku limit 0,10;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-48.png"
	width="370"
	height="52"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-48_hu_bbf85316d0ef156.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-48_hu_239e4607ad8aa033.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="711"
		data-flex-basis="1707px"
	
></p>
<ul>
<li>查询tb_sku表从1000001开始的10条数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select * from tb_sku limit 1000000,10;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-49.png"
	width="380"
	height="54"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-49_hu_93d5798b9087cec9.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-49_hu_65b46d462964216b.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="703"
		data-flex-basis="1688px"
	
></p>
<ul>
<li>查询tb_sku表从第5000001开始的10条数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select * from tb_sku limit 5000000,10;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-50.png"
	width="366"
	height="46"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-50_hu_b2ab29218b925426.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-50_hu_4526e25b7b585a2d.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="795"
		data-flex-basis="1909px"
	
></p>
<ul>
<li>查询tb_sku表从第9000001开始的10条数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select * from tb_sku limit 9000000,10;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-52.png"
	width="384"
	height="48"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-52_hu_d48606936640d496.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-52_hu_839c1b4a2cab986e.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="800"
		data-flex-basis="1920px"
	
></p>
<p>通过测试我们会看到，越往后，分页查询效率越低，这就是分页查询的问题所在。
因为，当在进行分页查询时，如果执行limit 9000000,10，此时需要MySQL排序前9000010记录，仅仅返回9000001-9000010的记录，其他记录丢弃，查询排序的代价非常大。</p>
<p>优化思路：一般分页查询时，通过创建 覆盖索引 能够比较好地提高性能，可以通过覆盖索引加子查询形式进行优化。</p>
<ul>
<li>查询9000001-9000010的id，顺序排序。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select id from tb_sku order by id limit 9000000,10;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-53.png"
	width="834"
	height="554"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-53_hu_5ec1c9ea1c2cfebe.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-53_hu_dfab16b889ee1ce8.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="150"
		data-flex-basis="361px"
	
></p>
<ul>
<li>对tb_sku与查询出来的id进行联表查询，查询相同9000001-9000010的数据信息</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select s.* from tb_sku s, (select id from tb_sku order by id limit 9000000,10) a where s.id = a.id;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-54.png"
	width="364"
	height="48"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-54_hu_8dc332b3ddadb4c0.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-54_hu_b7f296c84670786.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="758"
		data-flex-basis="1820px"
	
></p>
<ul>
<li>对tb_sku与查询出来的id进行联表查询，查询相同9000001-9000010的数据信息(执行计划)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select s.* from tb_sku s , (select id from tb_sku order by id limit 9000000,10) a where s.id = a.id;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-55.png"
	width="1898"
	height="304"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-55_hu_c336b6b0d73622b4.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-55_hu_728705c617f8cdd6.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="624"
		data-flex-basis="1498px"
	
></p>
<ul>
<li>查询tb_sku表从第9000001开始的10条数据(执行计划)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">explain select * from tb_sku limit 9000000,10;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-56.png"
	width="1686"
	height="250"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-56_hu_f600d4b475600d2a.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-56_hu_445cb02db75a5de1.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="674"
		data-flex-basis="1618px"
	
></p>
<h2 id="count优化">count优化
</h2><h3 id="概述">概述
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select count(*) from tb_sku;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-57.png"
	width="518"
	height="250"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-57_hu_2a27270c657055cd.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-57_hu_9797832d4e37eb19.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="207"
		data-flex-basis="497px"
	
></p>
<p>在之前的测试中，我们发现，如果数据量很大，在执行count操作时，时非常耗时的。</p>
<ul>
<li>MyISAM引擎把一个表的总行数存在了磁盘上，因此执行count(*)的时候会直接返回这个数，效率很高；但是如果时带条件的count，MyISAM也慢。</li>
<li>InnoDB引擎就麻烦了，它执行count(*)的时候，需要数据一行一行地从引擎里面读出来，然后累积计数。</li>
</ul>
<p>如果说要大幅度提升InnoDB表的count效率，主要的优化思路：自己计数(可以借助于redis这样的数据库进行，但是如果是带条件的count又比较麻烦了)。</p>
<p><font color=red>InnoDB的行锁是针对索引加的锁，不是针对记录加的锁，并且该索引不能失效，否则会从行锁升级为表锁。</font></p>
<h3 id="count用法">count用法
</h3><p>count()是一个聚合函数，对于返回的结果集，一行行地判断，如果count函数不是NULL，累计值就加1，否则就不加，最后返回累计值。</p>
<p>用法：count(*)、count(主键)、count(字段)、count(数字)</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>count用法</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>count(主键)</td>
          <td>InnoDB引擎会遍历整张表，把每一行的主键id值都取出来，返回给服务层。服务层拿到主键后，直接按行进行累加(主键不可能为null)</td>
      </tr>
      <tr>
          <td>count(字段)</td>
          <td>没有not null约束：InnoDB引擎会遍历整张表把每一行的字段值都取出来，返回给服务层，服务层判断是否为null，不为null，计数累加。<br>有not null约束：InnoDB引擎会遍历整张表把每一行的字段都取出来，返回给服务层，直接按行进行累加。</td>
      </tr>
      <tr>
          <td>count(数字)</td>
          <td>InnoDB引擎遍历整张表，但不取值。服务层对于返回的每一行，放一个数字“1”进去，直接按行进行累加。</td>
      </tr>
      <tr>
          <td>count(*)</td>
          <td>InnoDB引擎并不会把全部字段取出来，而是专门做了优化，不取值，服务层直接按行进行累加。</td>
      </tr>
  </tbody>
</table></div>
<blockquote>
<p>按照效率排序的话，count(字段) &lt; count(主键 id) &lt; count(1) ≈ count(*)，所以尽量使用count(*)。</p>
</blockquote>
<h3 id="演示-1">演示
</h3><ul>
<li>count(*)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select count(*) from tb_user;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-58.png"
	width="520"
	height="244"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-58_hu_c772acfeecab087.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-58_hu_60e88dfc442c924f.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="213"
		data-flex-basis="511px"
	
></p>
<ul>
<li>count(id)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select count(id) from tb_user;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-59.png"
	width="546"
	height="246"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-59_hu_2e0b649ab996a80.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-59_hu_35099ec23b34b681.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="221"
		data-flex-basis="532px"
	
></p>
<ul>
<li>count(字段)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 设置id为24的用户，profession为null
</span></span><span class="line"><span class="cl">update tb_user set profession = null where id = 24;
</span></span><span class="line"><span class="cl">select count(profession) from tb_user;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-60.png"
	width="650"
	height="248"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-60_hu_1fb48c236a2830ff.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-60_hu_9f9feb574fa76e0f.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="262"
		data-flex-basis="629px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-61.png"
	width="830"
	height="384"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-61_hu_f7c01addb0dc3f31.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-61_hu_7798d45b3a16bbb6.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="216"
		data-flex-basis="518px"
	
></p>
<p>字段为null的话将不会被计数。</p>
<ul>
<li>count(null)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select count(null) from tb_user;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-62.png"
	width="570"
	height="242"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-62_hu_1e5c41febf1f3897.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-62_hu_2e345192fc90e19f.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="235"
		data-flex-basis="565px"
	
></p>
<ul>
<li>count(1)，数字随意输入，比如 -1，0</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select count(1) from tb_user;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-63.png"
	width="528"
	height="244"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-63_hu_6c1af0c3cc8bb3ff.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-63_hu_914dfada37cb096b.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="216"
		data-flex-basis="519px"
	
></p>
<h2 id="update优化">update优化
</h2><ul>
<li>使用数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">select * from course;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-64.png"
	width="418"
	height="348"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-64_hu_a3f7bcd63f924827.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-64_hu_a5dfc2b594cb21e6.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="120"
		data-flex-basis="288px"
	
></p>
<h3 id="演示-2">演示
</h3><p><strong>测试行锁：</strong></p>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;A电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>开启事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">begin;
</span></span></code></pre></td></tr></table>
</div>
</div><p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;B电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>开启事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">begin;
</span></span></code></pre></td></tr></table>
</div>
</div><p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;A电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>修改数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">update course set name = &#39;javaEE&#39; where id = 1;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-65.png"
	width="778"
	height="116"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-65_hu_59a7e1f409c585fc.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-65_hu_1365f1612440c576.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="670"
		data-flex-basis="1609px"
	
></p>
<p>此时MySQL会给该表添加id为1的行锁，将id为1这行数据锁起来。只要事务未提交，该行锁将不会解锁。</p>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;B电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>修改数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">update course set name = &#39;Kafka&#39; where id = 4;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-66.png"
	width="760"
	height="118"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-66_hu_7ded30b7a7a239de.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-66_hu_724ef198c115caf.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="644"
		data-flex-basis="1545px"
	
></p>
<p>因为加的是行锁，电脑A给id为1的数据添加了行锁，所以B电脑能够正常执行。</p>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;A电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>提交事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">commit;
</span></span></code></pre></td></tr></table>
</div>
</div><p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;B电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>提交事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">commit;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>测试表锁：</strong></p>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;A电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>开启事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">begin;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>修改数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">update course set name = &#39;SpringBoot&#39; where name = &#39;PHP&#39;;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-67.png"
	width="922"
	height="116"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-67_hu_4af3fb625f362e7f.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-67_hu_a80e3dd8b4ad20f5.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="794"
		data-flex-basis="1907px"
	
></p>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;B电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>开启事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">begin;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>修改数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">update course set name = &#39;redis&#39; where id = 4;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-68.png"
	width="760"
	height="80"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-68_hu_54b091b4dfab3acc.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-68_hu_24b1be4af348f072.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="950"
		data-flex-basis="2280px"
	
></p>
<p>此时MySQL在此处卡住，因为A电脑在执行update语句的时候，name字段没有索引，MySQL加的为表锁，而不是行锁</p>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;A电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>提交事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">commit
</span></span></code></pre></td></tr></table>
</div>
</div><p>提交成功后，B电脑继续向下运行。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-69.png"
	width="784"
	height="120"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-69_hu_bf4671ba2f9c2711.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-69_hu_3778dd0a373cdb82.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="653"
		data-flex-basis="1568px"
	
></p>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;B电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>提交事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">commit
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>name字段添加索引后再次修改：</strong></p>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;A电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>创建索引</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">create index idx_course_name on course(name);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-70.png"
	width="744"
	height="112"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-70_hu_5170aab9af6f121d.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-70_hu_7fb388c02c9e5dd0.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="664"
		data-flex-basis="1594px"
	
></p>
<ul>
<li>开启事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">begin;
</span></span></code></pre></td></tr></table>
</div>
</div><p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;B电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>开启事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">begin;
</span></span></code></pre></td></tr></table>
</div>
</div><p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;A电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>修改数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">update course set name = &#39;Spring&#39; where name = &#39;SpringBoot&#39;;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-71.png"
	width="956"
	height="108"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-71_hu_725697b7e56e04c2.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-71_hu_9061c7576ce9aec6.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="885"
		data-flex-basis="2124px"
	
></p>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;B电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>修改数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">update course set name = &#39;Cloud&#39; where id = 4;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-72.png"
	width="762"
	height="114"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-72_hu_3a995c6391b0d2d9.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-sql%E4%BC%98%E5%8C%96/image-72_hu_d48d29edc3df8321.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="668"
		data-flex-basis="1604px"
	
></p>
<ul>
<li>提交事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">commit;
</span></span></code></pre></td></tr></table>
</div>
</div><p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;A电脑&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p>
<ul>
<li>提交事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">commit;
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E7%AE%A1%E7%90%86/">
        
        

        <div class="article-details">
            <h2 class="article-title">[MySQL]MySQL进阶-管理</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/mysqlmysql%E8%BF%9B%E9%98%B6-innodb%E5%BC%95%E6%93%8E/">
        
        

        <div class="article-details">
            <h2 class="article-title">[MySQL]MySQL进阶-InnoDB引擎</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/">
        
        

        <div class="article-details">
            <h2 class="article-title">[MySQL]MySQL进阶-锁</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/mysql%E8%BF%9B%E9%98%B6-%E8%A7%A6%E5%8F%91%E5%99%A8/">
        
        

        <div class="article-details">
            <h2 class="article-title">[MySQL]进阶-触发器</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B/">
        
        

        <div class="article-details">
            <h2 class="article-title">[MySQL]MySQL进阶-存储过程</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 リンボの個人ブログ
    </section>
    
    <section class="powerby">
         <br />
        
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
