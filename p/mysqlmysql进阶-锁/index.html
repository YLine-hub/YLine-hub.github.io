<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="MySQL进阶-锁 概述 锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库中，除传统的计算资源(CPU、 RAM、I/O)的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有 效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个 角度来说，锁对数据库而言显得尤其重要，也更加复杂。\n">
<title>[MySQL]MySQL进阶-锁</title>

<link rel='canonical' href='https://YLine-hub.github.io/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/'>

<link rel="stylesheet" href="/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css"><meta property='og:title' content="[MySQL]MySQL进阶-锁">
<meta property='og:description' content="MySQL进阶-锁 概述 锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库中，除传统的计算资源(CPU、 RAM、I/O)的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有 效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个 角度来说，锁对数据库而言显得尤其重要，也更加复杂。\n">
<meta property='og:url' content='https://YLine-hub.github.io/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/'>
<meta property='og:site_name' content='リンボの個人ブログ'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-11-24T00:18:53&#43;08:00'/><meta property='article:modified_time' content='2025-11-24T00:18:53&#43;08:00'/>
<meta name="twitter:title" content="[MySQL]MySQL进阶-锁">
<meta name="twitter:description" content="MySQL进阶-锁 概述 锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库中，除传统的计算资源(CPU、 RAM、I/O)的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有 效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个 角度来说，锁对数据库而言显得尤其重要，也更加复杂。\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_7f398a7818085507.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🏖️</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">リンボの個人ブログ</a></h1>
            <h2 class="site-description">努力不一定能获得回报，但不努力一定不会有回报。</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#概述">概述</a></li>
    <li><a href="#全局锁">全局锁</a>
      <ol>
        <li><a href="#介绍">介绍</a></li>
        <li><a href="#语法">语法</a></li>
        <li><a href="#特点">特点</a></li>
        <li><a href="#示例">示例</a></li>
        <li><a href="#生词">生词</a></li>
      </ol>
    </li>
    <li><a href="#表级锁">表级锁</a>
      <ol>
        <li><a href="#介绍-1">介绍</a></li>
        <li><a href="#表锁">表锁</a>
          <ol>
            <li><a href="#语法-1">语法</a></li>
            <li><a href="#特点-1">特点</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#元数据锁">元数据锁</a>
      <ol>
        <li><a href="#演示">演示</a></li>
      </ol>
    </li>
    <li><a href="#意向锁">意向锁</a>
      <ol>
        <li><a href="#介绍-2">介绍</a></li>
        <li><a href="#分类">分类</a>
          <ol>
            <li><a href="#演示-1">演示</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#行级锁">行级锁</a>
      <ol>
        <li><a href="#介绍-3">介绍</a></li>
        <li><a href="#行锁">行锁</a>
          <ol>
            <li><a href="#介绍-4">介绍</a></li>
            <li><a href="#演示-2">演示</a></li>
            <li><a href="#示例演示">示例演示</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#间隙锁临键锁">间隙锁&amp;临键锁</a>
      <ol>
        <li><a href="#示例演示-1">示例演示</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/mysql/" >
                MySQL
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/">[MySQL]MySQL进阶-锁</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-11-24</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="mysql进阶-锁">MySQL进阶-锁
</h1><h2 id="概述">概述
</h2><blockquote>
<p>锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库中，除传统的计算资源(CPU、 RAM、I/O)的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有 效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个 角度来说，锁对数据库而言显得尤其重要，也更加复杂。</p>
</blockquote>
<ul>
<li>MySQL中的锁，按照锁的粒度分，分为以下三类:
<ul>
<li>全局锁:锁定数据库中的所有表。</li>
<li>表级锁:每次操作锁住整张表。</li>
<li>行级锁:每次操作锁住对应的行数据。</li>
</ul>
</li>
</ul>
<h2 id="全局锁">全局锁
</h2><h3 id="介绍">介绍
</h3><blockquote>
<p>全局锁就是对整个数据库实例加锁，加锁后整个实例就处于只读状态，后续的DML的写语句，DDL语 句，已经更新操作的事务提交语句都将被阻塞。</p>
</blockquote>
<p>其典型的使用场景是做全库的逻辑备份，对所有的表进行锁定，从而获取一致性视图，保证数据的完整性。</p>
<p><font color=blue>为什么全库逻辑备份，就需要加全就锁呢?</font></p>
<p>A. 我们一起先来分析一下不加全局锁，可能存在的问题。</p>
<p>假设在数据库中存在这样三张表: tb_stock 库存表，tb_order 订单表，tb_orderlog 订单日志表。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image.png"
	width="884"
	height="222"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image_hu_1b9d22de0235ebd9.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image_hu_1ede1e018223316c.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="398"
		data-flex-basis="955px"
	
></p>
<ul>
<li>在进行数据备份时，先备份tb_stock库存表。</li>
<li>然后接下来，在业务系统中，执行了下单操作，扣减库存，生成订单(更新tb_stock表，插入tb_order表)。</li>
<li>然后再执行备份tb_order表的逻辑。</li>
<li>业务中执行插入订单日志操作。</li>
<li>最后，又备份tb_orderlog表。</li>
</ul>
<p>此时备份出来的数据，是存在问题的。因为备份出来的数据，tb_stock表与tb_order表的数据不一 致(有最新操作的订单信息,但是库存数没减)。</p>
<p>那如何来规避这种问题呢? 此时就可以借助于MySQL的全局锁来解决。</p>
<p>B.再来分析一下加了全局锁后的情况。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-1.png"
	width="884"
	height="242"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-1_hu_686e546b369e89b3.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-1_hu_1563782054bc3c20.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="365"
		data-flex-basis="876px"
	
></p>
<p>对数据库进行进行逻辑备份之前，先对整个数据库加上全局锁，一旦加了全局锁之后，其他的DDL、 DML全部都处于阻塞状态，但是可以执行DQL语句，也就是处于只读状态，而数据备份就是查询操作。 那么数据在进行逻辑备份的过程中，数据库中的数据就是不会发生变化的，这样就保证了数据的一致性 和完整性。</p>
<h3 id="语法">语法
</h3><ul>
<li>全局锁</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">flush</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="k">lock</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>数据备份</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysqldump -uroot -p123456 itcast &gt; itcast.sql 
</span></span></code></pre></td></tr></table>
</div>
</div><p>数据备份的相关指令，在后面MySQL管理章节，还会详细讲解。</p>
<ul>
<li>释放锁</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">unlock</span><span class="w"> </span><span class="n">tables</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="特点">特点
</h3><p>数据库中加全局锁，是一个比较重的操作，存在以下问题:</p>
<ul>
<li>如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆。</li>
<li>如果在从库上备份，那么在备份期间从库不能执行主库同步过来的二进制日志(binlog)，会导 致主从延迟。</li>
</ul>
<p>在InnoDB引擎中，我们可以在备份时加上参数 &ndash;single-transaction 参数来完成不加锁的一致 性数据备份。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysqldump --single-transaction -uroot -p123456 itcast &gt; itcast.sql
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="示例">示例
</h3><p><strong>数据准备</strong></p>
<ul>
<li>环境</li>
</ul>
<p>两个终端连接数据库：A、B</p>
<ul>
<li>创建数据库</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">db01</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>创建表</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">student</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;主键ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;姓名&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">no</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;学号&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;学生表&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="s1">&#39;黛绮丝&#39;</span><span class="p">,</span><span class="s1">&#39;2000100101&#39;</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="s1">&#39;谢逊&#39;</span><span class="p">,</span><span class="s1">&#39;2000100102&#39;</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="s1">&#39;殷天正&#39;</span><span class="p">,</span><span class="s1">&#39;2000100103&#39;</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="s1">&#39;韦一笑&#39;</span><span class="p">,</span><span class="s1">&#39;2000100104&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">course</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;主键ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;课程名称&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;课程表&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">course</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="s1">&#39;Java&#39;</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="s1">&#39;PHP&#39;</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="s1">&#39;MySQL&#39;</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="s1">&#39;Hadoop&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">student_course</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;主键&#39;</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">studentid</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;学生ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">courseid</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;课程ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">constraint</span><span class="w"> </span><span class="n">fk_courseid</span><span class="w"> </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">courseid</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">course</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">constraint</span><span class="w"> </span><span class="n">fk_studentid</span><span class="w"> </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="p">(</span><span class="n">studentid</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">student</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;学生课程中间表&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">student_course</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="k">null</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>终端A：设置全局锁</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 使用db01库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">use</span><span class="w"> </span><span class="n">db01</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 设置全局锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">flush</span><span class="w"> </span><span class="n">tables</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="k">lock</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-2.png"
	width="536"
	height="84"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-2_hu_8f1e3e0f34073ea8.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-2_hu_67b9ce75a506e1c5.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="638"
		data-flex-basis="1531px"
	
></p>
<ul>
<li>终端B：查询/修改学生表</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 使用db01
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">use</span><span class="w"> </span><span class="n">db01</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 查询学生表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 修改学生表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">update</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;A&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-3.png"
	width="460"
	height="346"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-3_hu_be888052a6760222.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-3_hu_98c00dec27e2b208.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="132"
		data-flex-basis="319px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-4.png"
	width="722"
	height="78"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-4_hu_a768e959cb470646.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-4_hu_370c578ddcf1f9ea.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="925"
		data-flex-basis="2221px"
	
></p>
<p>此时光标状态处于阻塞。</p>
<ul>
<li>终端C：备份数据库(不连接mysql)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysqldump -uroot -p123456 db01 &gt; /root/sql/db01.sql
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>报错</strong></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-5.png"
	width="1026"
	height="64"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-5_hu_ebb0bc4f54f5ee7.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-5_hu_f77ce2c791204844.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="1603"
		data-flex-basis="3847px"
	
></p>
<ul>
<li>原因</li>
</ul>
<p>未设置mysqldump软链接</p>
<ul>
<li>解决方法</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 查找mysql的安装路径
</span></span><span class="line"><span class="cl">find / -name mysql -print
</span></span><span class="line"><span class="cl"># 找到bin目录的 /usr/local/mysql/bin/
</span></span><span class="line"><span class="cl"># 设置软链接
</span></span><span class="line"><span class="cl">ln -fs /usr/local/mysql/bin/mysqldump /usr/bin
</span></span><span class="line"><span class="cl">ln -fs /usr/local/mysql/bin/mysql /usr/bin
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-6.png"
	width="976"
	height="34"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-6_hu_8cb51cc1db5bbe4a.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-6_hu_ce2df63d7578efc4.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="2870"
		data-flex-basis="6889px"
	
></p>
<p><strong>再次备份</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysqldump -uroot -p123456 db01 &gt; /root/sql/db01.sql
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-7.png"
	width="1202"
	height="68"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-7_hu_ad775dddc58636d.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-7_hu_1b70b44109481e06.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="1767"
		data-flex-basis="4242px"
	
></p>
<ul>
<li>查看文件是否存在</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">find /root/sql -type f -name &#39;db01.sql&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-8.png"
	width="858"
	height="70"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-8_hu_d4aba9fcce247367.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-8_hu_ace7032c26bea61a.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="1225"
		data-flex-basis="2941px"
	
></p>
<ul>
<li>查看文件内容</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">vim /root/sql/db01.sql
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-9.png"
	width="1364"
	height="916"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-9_hu_6e5c1841cf47cd44.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-9_hu_f2b00214dd8fcf5c.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="148"
		data-flex-basis="357px"
	
></p>
<ul>
<li>终端A：解锁</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">unlock tables;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-11.png"
	width="524"
	height="84"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-11_hu_4653d934168206b3.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-11_hu_a4a7d95cc789308a.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="623"
		data-flex-basis="1497px"
	
></p>
<h3 id="生词">生词
</h3><ul>
<li>interface / ˈɪntərfeɪs / n、(人机)界面；(计算机设备之间的)连接，接口； v、连接</li>
<li>insecure / ˌɪnsɪˈkjʊr / adj、缺乏信心的；不安全的</li>
</ul>
<h2 id="表级锁">表级锁
</h2><h3 id="介绍-1">介绍
</h3><p>表级锁，每次操作锁住整张表。锁定粒度大，发生锁冲突的概率最高，并发度最低。应用在MyISAM、 InnoDB、BDB等存储引擎中。
对于表级锁，主要分为以下三类:</p>
<ul>
<li>表锁</li>
<li>元数据锁(meta data lock，MDL)</li>
<li>意向锁</li>
</ul>
<h3 id="表锁">表锁
</h3><p>对于表锁，分为两类:</p>
<ul>
<li>表共享读锁(read lock)</li>
<li>表独占写锁(write lock)</li>
</ul>
<h4 id="语法-1">语法
</h4><ul>
<li>加锁</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lock tables 表名... read/write
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>释放锁</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">unlock tables / 客户端断开连接
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="特点-1">特点
</h4><p>A.读锁</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-10.png"
	width="884"
	height="232"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-10_hu_fabedf321443c507.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-10_hu_2aa5b13408f19546.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="381"
		data-flex-basis="914px"
	
></p>
<p>左侧为客户端一，对指定表加了读锁，不会影响右侧客户端二的读，但是会阻塞右侧客户端的写。</p>
<ul>
<li>测试</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-12.png"
	width="2880"
	height="1580"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-12_hu_99c069f6188944c7.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-12_hu_e87df58d3f9531b0.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="182"
		data-flex-basis="437px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-13.png"
	width="2880"
	height="1580"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-13_hu_893cd5f7f3a6d53f.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-13_hu_25e64acdce3f1aa6.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="182"
		data-flex-basis="437px"
	
></p>
<p>B.写锁</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-14.png"
	width="884"
	height="236"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-14_hu_e25460d93c78f404.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-14_hu_16c6a187710e04e1.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="374"
		data-flex-basis="898px"
	
></p>
<p>左侧为客户端一，对指定表加了写锁，会阻塞右侧客户端的读和写。</p>
<ul>
<li>测试:</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-15.png"
	width="2880"
	height="1580"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-15_hu_4403f5a9fba7332.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-15_hu_c8e1da9ca95ae6a4.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="182"
		data-flex-basis="437px"
	
></p>
<blockquote>
<p>结论: 读锁不会阻塞其他客户端的读，但是会阻塞写。写锁既会阻塞其他客户端的读，又会阻塞 其他客户端的写。</p>
</blockquote>
<h2 id="元数据锁">元数据锁
</h2><blockquote>
<p>meta data lock , 元数据锁，简写MDL。
MDL加锁过程是系统自动控制，无需显式使用，在访问一张表的时候会自动加上。MDL锁主要作用是维 护表元数据的数据一致性，在表上有活动事务的时候，不可以对元数据进行写入操作。 <strong>为了避免DML与 DDL冲突，保证读写的正确性。</strong></p>
</blockquote>
<p>这里的元数据，大家可以简单理解为就是一张表的表结构。也就是说，某一张表涉及到未提交的事务时，是不能够修改这张表的表结构的。
在MySQL5.5中引入了MDL，当对一张表进行增删改查的时候，加MDL读锁(共享);当对表结构进行变 更操作的时候，加MDL写锁(排他)。
常见的SQL操作时，锁添加的元数据锁：</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>对应SQL</th>
          <th>锁类型</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>lock tables xxx read / write</td>
          <td>SHARED_READ_ONLY / SHARED_NO_READ_WRITE</td>
          <td></td>
      </tr>
      <tr>
          <td>select、select &hellip; lock in share mode</td>
          <td>SHARED_READ</td>
          <td>与SAHRED_READ、SHARED_WRITE兼容，与EXCLUSIVE互斥</td>
      </tr>
      <tr>
          <td>insert、update、delete、select&hellip;</td>
          <td>SHARED_WRITE</td>
          <td>与SHARED_READ、SHARED_WRITE兼容，与EXCLUSIVE互斥</td>
      </tr>
      <tr>
          <td>alter table &hellip;</td>
          <td>EXCLUSIVE</td>
          <td>与其他的MDL都互斥</td>
      </tr>
  </tbody>
</table></div>
<h3 id="演示">演示
</h3><ul>
<li>当执行SELECT、INSERT、UPDATE、DELETE等语句时，添加的是元数据共享锁(SHARED_READ / SHARED_WRITE)，之间是兼容的。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-16.png"
	width="2880"
	height="1580"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-16_hu_2560c2da6ca65f21.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-16_hu_9c41cbf29b0c656e.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="182"
		data-flex-basis="437px"
	
></p>
<ul>
<li>当执行SELECT语句时，添加的是元数据共享锁(SHARED_READ)，会阻塞元数据排他锁 (EXCLUSIVE)，之间是互斥的。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-17.png"
	width="2880"
	height="608"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-17_hu_fda7b69c4d684162.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-17_hu_177e2d73ea17670.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="473"
		data-flex-basis="1136px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-18.png"
	width="2880"
	height="832"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-18_hu_f9545423986606b4.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-18_hu_182793e8f4d11c08.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="346"
		data-flex-basis="830px"
	
></p>
<p>我们可以通过下面的SQL，来查看数据库中的元数据锁的情况:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">object_type</span><span class="p">,</span><span class="n">object_schema</span><span class="p">,</span><span class="n">object_name</span><span class="p">,</span><span class="n">lock_type</span><span class="p">,</span><span class="n">lock_duration</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">metadata_locks</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我们在操作过程中，可以通过上述的SQL语句，来查看元数据锁的加锁情况。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-19.png"
	width="2880"
	height="830"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-19_hu_92255911e210fb0e.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-19_hu_be795628f0bc853f.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="346"
		data-flex-basis="832px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-20.png"
	width="2880"
	height="1400"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-20_hu_a7360291267d024.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-20_hu_938dbc67f1080f16.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="205"
		data-flex-basis="493px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-21.png"
	width="2880"
	height="1580"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-21_hu_eb1f9c805033f3f4.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-21_hu_6c254db876a44da2.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="182"
		data-flex-basis="437px"
	
></p>
<h2 id="意向锁">意向锁
</h2><h3 id="介绍-2">介绍
</h3><blockquote>
<p>为了避免DML在执行时，加的行锁与表锁的冲突，在InnoDB中引入了意向锁，使得表锁不用检查每行 数据是否加锁，使用意向锁来减少表锁的检查。</p>
</blockquote>
<p>假如没有意向锁，客户端一对表加了行锁后，客户端二如何给表加表锁呢，来通过示意图简单分析一下:</p>
<ul>
<li>首先客户端一，开启一个事务，然后执行DML操作，在执行DML语句时，会对涉及到的行加行锁。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-22.png"
	width="884"
	height="368"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-22_hu_7f42f41a0be10bb3.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-22_hu_a81ab9cd19433694.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="240"
		data-flex-basis="576px"
	
></p>
<ul>
<li>当客户端二，想对这张表加表锁时，会检查当前表是否有对应的行锁，如果没有，则添加表锁，此时就会从第一行数据，检查到最后一行数据，效率较低。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-23.png"
	width="884"
	height="276"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-23_hu_7b7c43635b90cebf.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-23_hu_6be8df343713be65.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="320"
		data-flex-basis="768px"
	
></p>
<p>有了意向锁之后 :</p>
<ul>
<li>客户端一，在执行DML操作时，会对涉及的行加行锁，同时也会对该表加上意向锁。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-24.png"
	width="884"
	height="380"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-24_hu_3e0dcdcfd3dbc925.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-24_hu_832620dad06bb5df.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="232"
		data-flex-basis="558px"
	
></p>
<ul>
<li>而其他客户端，在对这张表加表锁的时候，会根据该表上所加的意向锁来判定是否可以成功加表锁，而不用逐行判断行锁情况了。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-25.png"
	width="884"
	height="268"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-25_hu_cbdfd3094b6c3670.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-25_hu_59c23b6694c3b7b0.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="329"
		data-flex-basis="791px"
	
></p>
<h3 id="分类">分类
</h3><ul>
<li>意向共享锁(IS): 由语句<code>select ... lock in share mode</code>添加 。 与表锁共享锁 (read)兼容，与表锁排他锁(write)互斥。</li>
<li>意向排他锁(IX): 由<code>insert、update、delete、select...for update</code>添加 。与表锁共 享锁(read)及排他锁(write)都互斥，意向锁之间不会互斥。</li>
</ul>
<blockquote>
<p>一旦事务提交了，意向共享锁、意向排他锁，都会自动释放。</p>
</blockquote>
<p>可以通过以下SQL，查看意向锁及行锁的加锁情况:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">object_schema</span><span class="p">,</span><span class="n">object_name</span><span class="p">,</span><span class="n">index_name</span><span class="p">,</span><span class="n">lock_type</span><span class="p">,</span><span class="n">lock_mode</span><span class="p">,</span><span class="n">lock_data</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">data_locks</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="演示-1">演示
</h4><p>A、意向共享锁与表读锁是兼容的</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-26.png"
	width="2880"
	height="824"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-26_hu_63f75944e38bafea.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-26_hu_e7103b40b1441fcb.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="349"
		data-flex-basis="838px"
	
></p>
<p>B. 意向排他锁与表读锁、写锁都是互斥的</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-27.png"
	width="2880"
	height="708"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-27_hu_4f79dfa1bb7ed2a9.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-27_hu_ce3398287ef0865b.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="406"
		data-flex-basis="976px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-28.png"
	width="2880"
	height="822"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-28_hu_413fe6dce6758606.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-28_hu_9a8ae46c1c4df1db.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="350"
		data-flex-basis="840px"
	
></p>
<h2 id="行级锁">行级锁
</h2><h3 id="介绍-3">介绍
</h3><blockquote>
<p>行级锁，每次操作锁住对应的行数据。锁定粒度最小，发生锁冲突的概率最低，并发度最高。应用在 InnoDB存储引擎中。</p>
</blockquote>
<p>InnoDB的数据是基于索引组织的，行锁是通过对索引上的索引项加锁来实现的，而不是对记录加的 锁。对于行级锁，主要分为以下三类:</p>
<ul>
<li>行锁(Record Lock):锁定单个行记录的锁，防止其他事务对此行进行update和delete。在 RC、RR隔离级别下都支持。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-29.png"
	width="840"
	height="90"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-29_hu_714d9f51f3393f29.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-29_hu_791ee0825fda8386.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="933"
		data-flex-basis="2240px"
	
></p>
<ul>
<li>间隙锁(Gap Lock):锁定索引记录间隙(不含该记录)，确保索引记录间隙不变，防止其他事 务在这个间隙进行insert，产生幻读。在RR隔离级别下都支持。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-30.png"
	width="840"
	height="106"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-30_hu_1cf2baceb261551b.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-30_hu_15c3bc75c3cd53a9.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="792"
		data-flex-basis="1901px"
	
></p>
<ul>
<li>临键锁(Next-Key Lock):行锁和间隙锁组合，同时锁住数据，并锁住数据前面的间隙Gap。 在RR隔离级别下支持。</li>
</ul>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-31.png"
	width="840"
	height="114"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-31_hu_b8a52f1fb4c59a6b.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-31_hu_ade91dcda5e967e5.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="736"
		data-flex-basis="1768px"
	
></p>
<h3 id="行锁">行锁
</h3><h4 id="介绍-4">介绍
</h4><p>InnoDB实现了以下两种类型的行锁:</p>
<ul>
<li>共享锁(S):允许一个事务去读一行，阻止其他事务获得相同数据集的排它锁。</li>
<li>排他锁(X):允许获取排他锁的事务更新数据，阻止其他事务获得相同数据集的共享锁和排他锁。</li>
</ul>
<p>两种行锁的兼容情况如下:</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-32.png"
	width="884"
	height="204"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-32_hu_6093cafdc6cc1acf.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-32_hu_2244c972ef727db9.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="433"
		data-flex-basis="1040px"
	
></p>
<p>常见的SQL语句，在执行时，所加的行锁如下:</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>SQL</th>
          <th>行锁类型</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>INSERT &hellip;</td>
          <td>排他锁</td>
          <td>自动加锁</td>
      </tr>
      <tr>
          <td>UPDATE &hellip;</td>
          <td>排他锁</td>
          <td>自动加锁</td>
      </tr>
      <tr>
          <td>DELETE &hellip;</td>
          <td>排他锁</td>
          <td>自动加锁</td>
      </tr>
      <tr>
          <td>SELECT(正常)</td>
          <td>不加任何锁</td>
          <td></td>
      </tr>
      <tr>
          <td>SELECT &hellip; LOCK IN SHARED MODE</td>
          <td>共享锁</td>
          <td>需要手动在SELECT之后加LOCK IN SHARED MODE</td>
      </tr>
      <tr>
          <td>SELECT &hellip; FOR UPDATE</td>
          <td>排他锁</td>
          <td>需要手动在SELECT之后加FOR UPDATE</td>
      </tr>
  </tbody>
</table></div>
<h4 id="演示-2">演示
</h4><p>默认情况下，InnoDB在 REPEATABLE READ事务隔离级别运行，InnoDB使用 next-key 锁进行搜
索和索引扫描，以防止幻读。</p>
<ul>
<li>针对唯一索引进行检索时，对已存在的记录进行等值匹配时，将会自动优化为行锁。</li>
<li>InnoDB的行锁是针对于索引加的锁，不通过索引条件检索数据，那么InnoDB将对表中的所有记 录加锁，此时 就会升级为表锁。</li>
</ul>
<p>可以通过以下SQL，查看意向锁及行锁的加锁情况:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">object_schema</span><span class="p">,</span><span class="n">object_name</span><span class="p">,</span><span class="n">index_name</span><span class="p">,</span><span class="n">lock_type</span><span class="p">,</span><span class="n">lock_mode</span><span class="p">,</span><span class="n">lock_data</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">data_locks</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="示例演示">示例演示
</h4><ul>
<li>数据准备</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">stu</span><span class="o">`</span><span class="w">  </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InnoDB</span><span class="w"> </span><span class="nb">CHARACTER</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utf8mb4</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">stu</span><span class="o">`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tom&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">stu</span><span class="o">`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cat&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">stu</span><span class="o">`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;rose&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">stu</span><span class="o">`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;jetty&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">stu</span><span class="o">`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lily&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">stu</span><span class="o">`</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;luci&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>演示行锁的时候，我们就通过上面这张表来演示一下。</p>
<p>A. 普通的select语句，执行时，不会加锁。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-33.png"
	width="2880"
	height="498"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-33_hu_2d001e7ca6c73b45.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-33_hu_667e7bd9f14ec5b5.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="578"
		data-flex-basis="1387px"
	
></p>
<p>B. <code>select...lock in share mode</code>，加共享锁，共享锁与共享锁之间兼容。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-34.png"
	width="2880"
	height="1266"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-34_hu_34c106eeea99c8dd.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-34_hu_a40182c4a01c135.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="227"
		data-flex-basis="545px"
	
></p>
<p>共享锁与排他锁之间互斥。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-35.png"
	width="2880"
	height="770"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-35_hu_69875e8880aa0c6c.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-35_hu_7435724837662a76.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="374"
		data-flex-basis="897px"
	
></p>
<p>客户端一获取的是id为1这行的共享锁，客户端二是可以获取id为3这行的排它锁的，因为不是同一行 数据。 而如果客户端二想获取id为1这行的排他锁，会处于阻塞状态，因为共享锁与排他锁之间互斥。</p>
<p>C. 排他锁与排他锁之间互斥</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-36.png"
	width="2880"
	height="696"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-36_hu_fc560e7d6fa9eb82.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-36_hu_bbfac1c9069c6406.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="413"
		data-flex-basis="993px"
	
></p>
<p>当客户端一，执行update语句，会为id为1的记录加排他锁; 客户端二，如果也执行update语句更 新id为1的数据，也要为id为1的数据加排他锁，但是客户端二会处于阻塞状态，因为排他锁之间是互 斥的。 直到客户端一，把事务提交了，才会把这一行的行锁释放，此时客户端二，解除阻塞。</p>
<p>D. 无索引行锁升级为表锁</p>
<p>stu表中数据如下:</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-37.png"
	width="388"
	height="412"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-37_hu_772dd0d67ed570f0.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-37_hu_23010bd50f42e21e.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="94"
		data-flex-basis="226px"
	
></p>
<p>我们在两个客户端中执行如下操作:</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-38.png"
	width="2880"
	height="396"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-38_hu_dbcb7f7341ef0eb6.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-38_hu_b7533f1d0aaa6cbe.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="727"
		data-flex-basis="1745px"
	
></p>
<p>在客户端一中，开启事务，并执行update语句，更新name为Lily的数据，也就是id为19的记录 。 然后在客户端二中更新id为3的记录，却不能直接执行，会处于阻塞状态，为什么呢?</p>
<p>原因就是因为此时，客户端一，根据name字段进行更新时，name字段是没有索引的，如果没有索引， 此时行锁会升级为表锁(因为行锁是对索引项加的锁，而name没有索引)。</p>
<p>接下来，我们再针对name字段建立索引，索引建立之后，再次做一个测试:</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-39.png"
	width="2880"
	height="516"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-39_hu_6f85cc6a5ed8b040.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-39_hu_d52891210b628449.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="558"
		data-flex-basis="1339px"
	
></p>
<p>此时我们可以看到，客户端一，开启事务，然后依然是根据name进行更新。而客户端二，在更新id为3 的数据时，更新成功，并未进入阻塞状态。 这样就说明，我们根据索引字段进行更新操作，就可以避免行锁升级为表锁的情况。</p>
<h2 id="间隙锁临键锁">间隙锁&amp;临键锁
</h2><p>默认情况下，InnoDB在 REPEATABLE READ事务隔离级别运行，InnoDB使用 next-key 锁进行搜索和索引扫描，以防止幻读。</p>
<ul>
<li>索引上的等值查询(唯一索引)，给不存在的记录加锁时, 优化为间隙锁。</li>
<li>索引上的等值查询(非唯一普通索引)，向右遍历时最后一个值不满足查询需求时，next-key lock 退化为间隙锁。</li>
<li>索引上的范围查询(唯一索引)&ndash;会访问到不满足条件的第一个值为止。</li>
</ul>
<blockquote>
<p>注意:间隙锁唯一目的是防止其他事务插入间隙。间隙锁可以共存，一个事务采用的间隙锁不会
阻止另一个事务在同一间隙上采用间隙锁。</p>
</blockquote>
<h3 id="示例演示-1">示例演示
</h3><p>A. 索引上的等值查询(唯一索引)，给不存在的记录加锁时, 优化为间隙锁 。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-40.png"
	width="2880"
	height="836"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-40_hu_6a9f44686a86f390.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-40_hu_75d3af41d11ce784.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="344"
		data-flex-basis="826px"
	
></p>
<p>B. 索引上的等值查询(非唯一普通索引)，向右遍历时最后一个值不满足查询需求时，next-key lock 退化为间隙锁。</p>
<p>介绍分析一下:
我们知道InnoDB的B+树索引，叶子节点是有序的双向链表。 假如，我们要根据这个二级索引查询值 为18的数据，并加上共享锁，我们是只锁定18这一行就可以了吗? 并不是，因为是非唯一索引，这个 结构中可能有多个18的存在，所以，在加锁时会继续往后找，找到一个不满足条件的值(当前案例中也 就是29)。此时会对18加临键锁，并对29之前的间隙加锁。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-41.png"
	width="884"
	height="92"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-41_hu_ddaa6b40b117c2fe.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-41_hu_d1a654c2598ef42f.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="960"
		data-flex-basis="2306px"
	
></p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-42.png"
	width="2880"
	height="1090"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-42_hu_3a90a89c2da21309.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-42_hu_50c744b4ac2ba110.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="264"
		data-flex-basis="634px"
	
></p>
<p>C. 索引上的范围查询(唯一索引)&ndash;会访问到不满足条件的第一个值为止。</p>
<p><img src="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-43.png"
	width="2880"
	height="1042"
	srcset="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-43_hu_a2ba41c11722ae6f.png 480w, /p/mysqlmysql%E8%BF%9B%E9%98%B6-%E9%94%81/image-43_hu_156ac5a3e2f7c188.png 1024w"
	loading="lazy"
	
		alt="alt text"
	
	
		class="gallery-image" 
		data-flex-grow="276"
		data-flex-basis="663px"
	
></p>
<p>查询的条件为id&gt;=19，并添加共享锁。此时我们可以根据数据库表中现有的数据，将数据分为三个部分:
[19]
(19,25]
(25,+∞]
所以数据库数据在加锁是，就是将19加了行锁，25的临键锁(包含25及25之前的间隙)，正无穷的临键锁(正无穷及之前的间隙)。</p>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/mysqlmysql%E8%BF%90%E7%BB%B4-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">
        
        

        <div class="article-details">
            <h2 class="article-title">[MySQL]MySQL运维-读写分离</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/mysqlmysql%E8%BF%90%E7%BB%B4-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">
        
        

        <div class="article-details">
            <h2 class="article-title">[MySQL]MySQL运维-主从复制</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/mysqlmysql%E8%BF%90%E7%BB%B4-%E6%97%A5%E5%BF%97/">
        
        

        <div class="article-details">
            <h2 class="article-title">[MySQL]MySQL运维-日志</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/mysqlmysql%E8%BF%9B%E9%98%B6-%E7%AE%A1%E7%90%86/">
        
        

        <div class="article-details">
            <h2 class="article-title">[MySQL]MySQL进阶-管理</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/mysqlmysql%E8%BF%9B%E9%98%B6-innodb%E5%BC%95%E6%93%8E/">
        
        

        <div class="article-details">
            <h2 class="article-title">[MySQL]MySQL进阶-InnoDB引擎</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 リンボの個人ブログ
    </section>
    
    <section class="powerby">
         <br />
        
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
